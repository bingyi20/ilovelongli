<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>写给龙丽的情书</title>
	<style type="text/css">
		*{
			padding: 0;
			margin: 0;
		}
		.app{
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;
			left: 0;
			overflow: hidden;
		}
		.backgroundCity {
			position: absolute;
			width: 100%;
			bottom: 0;
			z-index: 100;
		}
		.backgroundCity img {
			width: 100%;
		}
		.moon {
			width: 100px;
			height: 100px;
			position: absolute;
			top: 100px;
			left: 50px;
			z-index: 100;
			box-shadow: 5px 5px 5px #fff outset;
			opacity: 0.8;
		}
		.moon img {
			width: 100%;
			height: 100%;
		}
		#carousel {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			border-radius: 50%;
			background-size: cover;
		}
		.bangyu {
			position: absolute;
			right: 0;
			bottom: -5px;
			z-index: 100;
			transition: all 1s ease-out;
		}
		.bangyu img {
			width: 100px;
		}
		.longli {
			position: absolute;
			left: 0;
			bottom: 0;
			z-index: 100;
			transform: rotateY(180deg);
			transition: all 1s ease-in;
			bottom: -5px;
		}
		.longli img {
			width: 110px;
		}
		#animationTest {
			z-index: 100;
			position: fixed;
			top: 0;
			left: 100;
			width: 100;
			height: 100;
		}
		canvas {
			background-color:rgba(0,0,0);
			position: absolute;
			left: 0;
			top: 0;
		}
		.card {
            width: 50px;
            height: 50px;
            position: absolute;
            bottom: 0;
            left: -25px;
            background-color: bisque;
            display: flex;
            justify-content: center;
            align-items: center;
			transition: all 2s ease-in;
			background-size: cover;
			z-index: 101;
			opacity: 0.9;
			border-radius: 50%;
        }
	</style>
</head>
<body>
	<div class="app" id="app">
		<canvas id="canvas"  width="375" height="812">浏览器不支持canvas</canvas>
		<div class="backgroundCity">
			<img src="./imgs/city.png">
		</div>
		<div class="moon">
			<img  src="./imgs/moon.png">
			<div id="carousel" style="opacity: 0;"></div>
		</div>
		<div class="bangyu" id="bangyu">
			<img src="./imgs/bangyu.png">
		</div>
		<div class="longli" id="longli">
			<img src="./imgs/longli.png" alt="">
		</div>

		<audio id="music" autoplay="autoplay" loop>
			<source src="./andio/bg.mp3" type="audio/mp3">
		  	您的浏览器不支持 audio 元素。
		  </audio>
		
	</div>
	<script>
		document.querySelector('#canvas').width = window.screen.width
		document.querySelector('#canvas').height = window.screen.height
	</script>
	<script src="./utils.js"></script>
	<script type="text/javascript" src="./fireworks.js"></script>

	<script>
		const app = document.querySelector('#app')
		const screenWidth = window.screen.width
    	const screenHeight = window.screen.height
		const images = new Array(27).fill(0).map((_, idx) => `./imgs/people-${idx+1}.jpg`)
		// 轮播
		const play = (url) => {
			const carousel = document.querySelector('#carousel')
			let opacity = 0
			return new Promise((resolve) => {
				// 2. 替换图片
				carousel.style.backgroundImage = `url(${url})`
				// 3. 不断明显
				const opaque = () => {
					opacity += 0.1
					carousel.style.opacity = opacity
					if(opacity < 0.8) {
						setTimeout(() => {
							opaque()
						}, 100)
					} else {
						carousel.style.opacity = 0
						resolve(url)
					}
				}
				opaque()
			})
		}

		const generatorCard = (url, top, left, size) => {
			console.log(top, left)
			const el = document.createElement('div')
			el.className = 'card'
			el.style.width = '100px'
			el.style.height = '100px'
			el.style.top = '100px'
			el.style.left = '50px'
			el.style.backgroundImage = `url('${url}')`
			app.appendChild(el)
			return new Promise((resolve) => {
				setTimeout(() => {
					el.style.top = top + 'px'
					el.style.left = left + 'px'
					el.style.width = size + 'px'
					el.style.height = size + 'px'
					el.style.borderRadius = 0
				}, 50)
				setTimeout(() => {
					resolve('成功啦')
				}, 2010)
			})
		}

		const positions = getHeartPositions()

		play(images[0]).then(url => {
			const {width, top, left} = positions[0]
			return generatorCard(url, top, left, width)
		})


		const bangyu = document.querySelector('#bangyu')
		const longli = document.querySelector('#longli')
		const START_OFFSET = screenWidth - 100
		bangyu.style.left = START_OFFSET + 'px'
		longli.style.right = START_OFFSET + 'px'

		const END_OFFSET = screenWidth/2 - 23
		const DIFF_OFFSET = START_OFFSET - END_OFFSET

		const coupleMove = () => {
			let left = parseFloat(bangyu.style.left)
			const df = DIFF_OFFSET / images.length
			left -= df
			if(left < END_OFFSET) {
				left = END_OFFSET
			}
			bangyu.style.left = left + 'px'
			longli.style.right = left + 'px'
		}


		const run = (idx) => {
			return play(images[idx]).then(url => {
				const {width, top, left} = positions[idx]
				coupleMove()
				return generatorCard(url, top, left, width)
			})
			console.log(images[idx])
		}

		let p = Promise.resolve()

		for(let i = 0; i < images.length; i++) {
			p = p.then(res => {
				return run(i)
			})
		}


		const playMusic = () => {
			const music = document.querySelector('#music')
			if(music.canPlay) {
				music.play()
			} else {
				alert('点击屏幕播放音乐')
				const once = () => {
					console.log('触发播放')
					music.play()
					app.removeEventListener('click', once)
				}
				app.addEventListener('click', once)
			}
		}
		playMusic()

		console.log(positions.length)
		console.log(images.length)

		



	</script>

</body>
</html>